<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ pet.name }} ‚Ä¢ Si me encontraste</title>
  <style>
    :root{
      --bg:#0b1220; --card:rgba(18,28,51,.92); --text:#eaf0ff; --muted:#93a4c7;
      --line:rgba(255,255,255,.10); --accent:#22d3ee; --accent2:#60a5fa;
      --ok:#34d399; --warn:#fbbf24; --danger:#fb7185;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1100px 600px at 10% 0%, rgba(34,211,238,.16), transparent 55%),
        radial-gradient(900px 500px at 95% 5%, rgba(96,165,250,.18), transparent 55%),
        var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      color:var(--text);
    }
    .wrap{max-width:760px;margin:0 auto;padding:14px 14px 92px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:20px;overflow:hidden;box-shadow:0 18px 60px rgba(0,0,0,.35);}
    .hero{position:relative;width:100%;height:min(44vh, 360px);background:rgba(255,255,255,.03);}
    .hero img{width:100%;height:100%;object-fit:cover;display:block;filter:saturate(1.05) contrast(1.05);}
    .hero:after{content:"";position:absolute;inset:0;background:linear-gradient(to top, rgba(11,18,32,.92), rgba(11,18,32,.10) 55%, rgba(11,18,32,0));}
    .hero-text{position:absolute;left:14px;right:14px;bottom:14px;z-index:2;}
    h1{margin:0;font-size:clamp(22px, 4.8vw, 30px);text-shadow:0 8px 30px rgba(0,0,0,.55);}
    .sub{margin:6px 0 0 0;color:rgba(234,240,255,.88);line-height:1.3;font-size:clamp(13px, 3.4vw, 15px);text-shadow:0 8px 30px rgba(0,0,0,.55);}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--line);color:var(--muted);background:rgba(255,255,255,.03);margin-top:10px;font-size:12px;}
    code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:8px;border:1px solid var(--line);}

    .content{padding:14px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media(max-width:560px){.grid{grid-template-columns:1fr;}}

    .btn{
      display:flex;align-items:center;justify-content:center;gap:10px;text-decoration:none;
      padding:14px 14px;border-radius:14px;font-weight:900;border:1px solid var(--line);
      color:var(--text);background:rgba(255,255,255,.03);font-size:16px;cursor:pointer;
    }
    .btn-primary{background:linear-gradient(90deg, rgba(34,211,238,.22), rgba(96,165,250,.22));border-color:rgba(34,211,238,.35);}
    .btn:hover{transform:translateY(-1px);transition:.12s ease;border-color:rgba(34,211,238,.35);}

    .box{padding:12px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.03);}
    .muted{color:var(--muted);}
    .title{font-weight:900;margin-bottom:6px;}
    .rows{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    @media(max-width:560px){.rows{grid-template-columns:1fr;}}
    .k{color:var(--muted);font-size:12px;margin-bottom:4px;}
    .v{font-weight:800;}

    details{border:1px solid var(--line);background:rgba(255,255,255,.03);border-radius:14px;overflow:hidden;}
    summary{list-style:none;cursor:pointer;padding:12px 12px;font-weight:900;display:flex;justify-content:space-between;align-items:center;}
    summary::-webkit-details-marker{display:none;}
    .details-body{padding:12px;border-top:1px solid var(--line);color:var(--muted);line-height:1.4;}

    textarea,input{
      width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:var(--text);outline:none;
    }
    textarea{min-height:92px;resize:vertical;}
    .small{font-size:12px;color:var(--muted);}

    /* Barra fija mobile */
    .bar{position:fixed;left:0;right:0;bottom:0;padding:10px 12px;background:rgba(11,18,32,.92);border-top:1px solid var(--line);
      backdrop-filter: blur(10px);-webkit-backdrop-filter: blur(10px);display:flex;justify-content:center;z-index:50;}
    .bar-inner{width:min(760px, 100%);display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .bar .btn{padding:14px 10px;border-radius:16px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hero">
        <img src="{{ pet.photo }}" alt="Foto de {{ pet.name }}">
        <div class="hero-text">
          <h1>Hola, soy {{ pet.name }} üêæ</h1>
          <div class="sub">{{ pet.breed }} ‚Ä¢ Si me encontraste, por favor ayudame a volver.</div>
          <div class="pill">üÜî <code>{{ pet_id }}</code> ‚Ä¢ ‚úÖ Gracias por ayudar</div>
        </div>
      </div>

      <div class="content">
        <div class="grid">
          {% if show_phone_public %}
          <a class="btn btn-primary" href="tel:{{ pet.phone }}">üìû Llamar a {{ pet.owner_name }}</a>
          {% else %}
          <button class="btn btn-primary" onclick="scrollToReport()">üßæ Enviar mensaje al due√±o</button>
          {% endif %}
          <a class="btn" href="https://wa.me/{{ pet.whatsapp }}?text=Hola!%20Encontr%C3%A9%20a%20{{ pet.name }}%20(%23{{ pet_id }})">üí¨ WhatsApp</a>
        </div>

        <div style="height:12px"></div>

        <div class="box">
          <div class="title">üìå Datos r√°pidos</div>
          <div class="rows">
            <div><div class="k">Sexo</div><div class="v">{{ pet.sex }}</div></div>
            <div><div class="k">Edad</div><div class="v">{{ pet.age }}</div></div>
            <div><div class="k">Tama√±o</div><div class="v">{{ pet.size }}</div></div>
            <div><div class="k">Color</div><div class="v">{{ pet.color }}</div></div>
          </div>
          <div style="height:10px"></div>
          <div class="small">Chip: <code>{{ pet.chip_id }}</code> ‚Ä¢ Vacunas: <b>{{ pet.vaccines }}</b> ‚Ä¢ Castrado: <b>{{ pet.sterilized }}</b></div>
        </div>

        <div style="height:12px"></div>

        <details open>
          <summary>üß† Importante <span class="muted">‚ñº</span></summary>
          <div class="details-body">
            <div><b>Comportamiento:</b> {{ pet.temperament }}</div>
            <div style="height:8px"></div>
            <div><b>Nota:</b> {{ pet.notes }}</div>
            <div style="height:8px"></div>
            <div><b>Se√±as particulares:</b> {{ pet.distinctive }}</div>
          </div>
        </details>

        <div style="height:12px"></div>

        <details>
          <summary>ü©∫ Salud <span class="muted">‚ñº</span></summary>
          <div class="details-body">
            <div><b>Alergias:</b> {{ pet.allergies }}</div>
            <div><b>Medicaci√≥n:</b> {{ pet.meds }}</div>
          </div>
        </details>

        <div style="height:12px"></div>

        <details>
          <summary>üß≠ Qu√© hacer si lo encontraste <span class="muted">‚ñº</span></summary>
          <div class="details-body">
            <ul>
              {% for item in pet.what_to_do %}
                <li>{{ item }}</li>
              {% endfor %}
            </ul>
            {% if pet.reward and pet.reward != "‚Äî" %}
              <div>üéÅ <b>Recompensa:</b> {{ pet.reward }}</div>
            {% endif %}
          </div>
        </details>

        <div style="height:12px"></div>

        <div class="grid">
          <a class="btn" href="/v/{{ pet_id }}.vcf">üë§ Guardar contacto</a>
          <button class="btn" onclick="sharePage()">üîó Compartir ficha</button>
        </div>

        {% if geo_enabled %}
          <div style="height:12px"></div>
          <div class="box" id="geoBox">
            <div class="title">üìç Compartir tu ubicaci√≥n</div>
            <div class="muted">Si acept√°s, nos llega tu ubicaci√≥n para ir a buscarlo m√°s r√°pido.</div>
            <div style="height:10px"></div>
            <button class="btn btn-primary" style="width:100%;" onclick="shareLocation()">Compartir ubicaci√≥n</button>
            <div class="muted" id="geoStatus" style="margin-top:10px; font-size:13px;"></div>
          </div>
        {% endif %}

        <div style="height:12px"></div>

        <div class="box" id="reportBox">
          <div class="title">üßæ Enviar mensaje al due√±o</div>
          <div class="muted">Escrib√≠ d√≥nde lo viste y cualquier detalle. (Llega a Discord)</div>
          <div style="height:10px"></div>

          <div class="small">Tu contacto (opcional):</div>
          <input id="contact" placeholder="Ej: +54 9... / Instagram / lo que sea" />

          <div style="height:10px"></div>
          <div class="small">Mensaje:</div>
          <textarea id="message" placeholder="Ej: Lo vi en la plaza, est√° bien, cerca del kiosco..."></textarea>

          <div style="height:10px"></div>
          <button class="btn btn-primary" style="width:100%;" onclick="sendReport()">Enviar mensaje</button>
          <div class="muted" id="reportStatus" style="margin-top:10px; font-size:13px;"></div>
        </div>

      </div>
    </div>
  </div>

  <div class="bar">
    <div class="bar-inner">
      {% if show_phone_public %}
      <a class="btn btn-primary" href="tel:{{ pet.phone }}">üìû Llamar</a>
      {% else %}
      <button class="btn btn-primary" onclick="scrollToReport()">üßæ Mensaje</button>
      {% endif %}
      <a class="btn" href="https://wa.me/{{ pet.whatsapp }}?text=Hola!%20Encontr%C3%A9%20a%20{{ pet.name }}%20(%23{{ pet_id }})">üí¨ WhatsApp</a>
    </div>
  </div>

<script>
function scrollToReport(){
  document.getElementById("reportBox").scrollIntoView({behavior:"smooth", block:"start"});
}

async function sharePage(){
  const url = window.location.href;
  if(navigator.share){
    try{ await navigator.share({ title: "Ficha de {{ pet.name }}", url }); }catch(e){}
  }else{
    await navigator.clipboard.writeText(url);
    alert("Link copiado ‚úÖ");
  }
}

async function shareLocation(){
  const status = document.getElementById("geoStatus");
  status.textContent = "Pidiendo ubicaci√≥n‚Ä¶";

  if(!navigator.geolocation){
    status.textContent = "Este dispositivo no soporta geolocalizaci√≥n.";
    return;
  }

  navigator.geolocation.getCurrentPosition(async (pos) => {
    try{
      const payload = { lat: pos.coords.latitude, lon: pos.coords.longitude, accuracy: pos.coords.accuracy };
      const res = await fetch(`/api/scan/{{ pet_id }}`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      status.textContent = data.ok ? "‚úÖ Ubicaci√≥n enviada. ¬°Gracias!" : "‚ö†Ô∏è No se pudo enviar la ubicaci√≥n.";
    }catch(e){
      status.textContent = "‚ö†Ô∏è Error enviando la ubicaci√≥n.";
    }
  }, () => {
    status.textContent = "No se comparti√≥ la ubicaci√≥n (rechazado o error).";
  }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
}

async function sendReport(){
  const status = document.getElementById("reportStatus");
  const message = (document.getElementById("message").value || "").trim();
  const contact = (document.getElementById("contact").value || "").trim();

  if(message.length < 3){
    status.textContent = "Escrib√≠ un mensaje un poco m√°s largo üôÇ";
    return;
  }

  status.textContent = "Enviando‚Ä¶";

  // Intentamos incluir ubicaci√≥n si la tiene (pero sin forzar permiso)
  let lat = null, lon = null;
  const doSend = async () => {
    try{
      const payload = { message, contact, lat, lon };
      const res = await fetch(`/api/report/{{ pet_id }}`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      status.textContent = data.ok ? "‚úÖ Enviado. ¬°Gracias!" : "‚ö†Ô∏è No se pudo enviar.";
    }catch(e){
      status.textContent = "‚ö†Ô∏è Error enviando.";
    }
  };

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition((pos) => {
      lat = pos.coords.latitude;
      lon = pos.coords.longitude;
      doSend();
    }, () => doSend(), { enableHighAccuracy: false, timeout: 4000, maximumAge: 60000 });
  }else{
    doSend();
  }
}
</script>
</body>
</html>

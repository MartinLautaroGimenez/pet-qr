<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin ‚Ä¢ Pet QR</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:rgba(18,28,51,.92); --text:#eaf0ff; --muted:#93a4c7;
      --line:rgba(255,255,255,.10); --accent:#22d3ee; --accent2:#60a5fa; --danger:#fb7185; --ok:#34d399;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1100px 600px at 10% 0%, rgba(34,211,238,.16), transparent 55%),
      radial-gradient(900px 500px at 95% 5%, rgba(96,165,250,.18), transparent 55%),var(--bg);
      color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .pill{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;margin-top:12px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:12px;box-shadow:0 18px 60px rgba(0,0,0,.35)}
    h1{margin:0;font-size:22px}
    h2{margin:0 0 10px 0;font-size:16px}
    label{font-size:12px;color:var(--muted)}
    input, textarea, select{
      width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:var(--text);outline:none
    }
    textarea{min-height:92px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.row{grid-template-columns:1fr}}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:var(--text);font-weight:900;text-decoration:none;cursor:pointer
    }
    .btn-primary{border-color:rgba(34,211,238,.35);background:linear-gradient(90deg, rgba(34,211,238,.22), rgba(96,165,250,.22))}
    .btn-danger{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.10)}
    .muted{color:var(--muted)}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(max-width:720px){.kpi{grid-template-columns:1fr}}
    .kpi .box{padding:12px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.03)}
    #map{height:360px;border-radius:16px;border:1px solid var(--line);overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:700}
    .badge{padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .lost{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.12)}
    .home{border-color:rgba(52,211,153,.35);background:rgba(52,211,153,.12)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Admin ‚Ä¢ Pet QR</h1>
        <div class="pill">TZ: {{ tz }} ‚Ä¢ Base: {{ base_url }}</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <form method="get" action="/admin" style="display:flex;gap:10px;align-items:center">
          <select name="pet" onchange="this.form.submit()">
            {% for p in pets %}
              <option value="{{ p.id }}" {% if p.id == selected_pet %}selected{% endif %}>{{ p.name }} ({{ p.id }})</option>
            {% endfor %}
          </select>
        </form>
        <a class="btn" href="/admin/logout">Salir</a>
      </div>
    </div>

    <div style="margin-top:12px" class="kpi">
      <div class="box">
        <div class="muted">Escaneos totales</div>
        <div style="font-weight:900;font-size:22px">{{ stats.total }}</div>
      </div>
      <div class="box">
        <div class="muted">Estado actual</div>
        <div style="font-weight:900;font-size:18px">
          {% if pet.status == "lost" %}
            <span class="badge lost">üö® PERDIDO</span>
          {% else %}
            <span class="badge home">‚úÖ EN CASA</span>
          {% endif %}
        </div>
      </div>
      <div class="box">
        <div class="muted">√öltima vez visto (UTC)</div>
        <div style="font-weight:900">{{ pet.last_seen_utc or "‚Äî" }}</div>
        <div class="muted" style="font-size:12px">Si hay ubicaci√≥n, aparece en el mapa.</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>üó∫Ô∏è Mapa en vivo (√∫ltimos puntos GPS)</h2>
        <div class="muted" style="margin-bottom:10px">
          Tip: si no ves puntos, todav√≠a no compartieron ubicaci√≥n (o el navegador la neg√≥).
        </div>
        <div id="map"></div>
        <div style="height:10px"></div>
        <div class="row">
          <a class="btn btn-primary" href="{{ base_url }}/p/{{ selected_pet }}" target="_blank">Abrir ficha p√∫blica</a>
          <a class="btn" href="{{ base_url }}/api/locations/{{ selected_pet }}?limit=25" target="_blank">Ver JSON puntos</a>
        </div>
      </div>

      <div class="card">
        <h2>üö¶ Modo ‚ÄúPerdido / En casa‚Äù</h2>
        <div class="muted">Cuando est√° ‚ÄúEn casa‚Äù, se apagan alertas inteligentes y la ficha puede mostrar un mensaje m√°s tranquilo.</div>
        <div style="height:10px"></div>
        <form method="post" action="/admin/pet/{{ selected_pet }}/status">
          <div class="row">
            <select name="status">
              <option value="lost" {% if pet.status=="lost" %}selected{% endif %}>üö® Perdido</option>
              <option value="home" {% if pet.status=="home" %}selected{% endif %}>‚úÖ En casa</option>
            </select>
            <button class="btn btn-primary" type="submit">Guardar estado</button>
          </div>
        </form>

        <div style="height:16px"></div>

        <h2>üë• Contactos</h2>
        <table>
          <thead>
            <tr>
              <th>Prio</th><th>Etiqueta</th><th>Nombre</th><th>Tel</th><th>WhatsApp</th><th></th>
            </tr>
          </thead>
          <tbody>
            {% for c in contacts %}
              <tr>
                <td>{{ c.priority }}</td>
                <td>{{ c.label }}</td>
                <td>{{ c.name }}</td>
                <td>{{ c.phone }}</td>
                <td>{{ c.whatsapp }}</td>
                <td>
                  <form method="post" action="/admin/contact/{{ c.id }}/delete" style="margin:0">
                    <input type="hidden" name="pet_id" value="{{ selected_pet }}">
                    <button class="btn btn-danger" type="submit">Borrar</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
            {% if contacts|length == 0 %}
              <tr><td colspan="6" class="muted">Sin contactos.</td></tr>
            {% endif %}
          </tbody>
        </table>

        <div style="height:10px"></div>

        <form method="post" action="/admin/pet/{{ selected_pet }}/contact/add">
          <div class="row">
            <div>
              <label>Etiqueta</label>
              <input name="label" value="Contacto">
            </div>
            <div>
              <label>Prioridad (1 = principal)</label>
              <input name="priority" type="number" value="1">
            </div>
          </div>
          <div class="row">
            <div>
              <label>Nombre</label>
              <input name="name" required>
            </div>
            <div>
              <label>Tel√©fono</label>
              <input name="phone" placeholder="+54...">
            </div>
          </div>
          <div class="row">
            <div>
              <label>WhatsApp (solo n√∫meros + pa√≠s)</label>
              <input name="whatsapp" placeholder="549261...">
            </div>
            <div style="display:flex;align-items:end">
              <button class="btn btn-primary" type="submit" style="width:100%">Agregar contacto</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <h2>üßæ Editar ficha + ‚Äúcasa‚Äù (para alertas de distancia)</h2>
      <div class="muted">Si carg√°s HOME_LAT/HOME_LON, las alertas pueden avisar si aparece lejos.</div>
      <div style="height:10px"></div>

      <form method="post" action="/admin/pet/{{ selected_pet }}/update">
        <div class="row">
          <div><label>Nombre</label><input name="name" value="{{ pet.name }}"></div>
          <div><label>Foto (URL)</label><input name="photo" value="{{ pet.photo or '' }}"></div>
        </div>

        <div class="row">
          <div><label>Raza</label><input name="breed" value="{{ pet.breed or '' }}"></div>
          <div><label>Sexo</label><input name="sex" value="{{ pet.sex or '' }}"></div>
        </div>

        <div class="row">
          <div><label>Edad</label><input name="age" value="{{ pet.age or '' }}"></div>
          <div><label>Tama√±o</label><input name="size" value="{{ pet.size or '' }}"></div>
        </div>

        <div class="row">
          <div><label>Color</label><input name="color" value="{{ pet.color or '' }}"></div>
          <div><label>Chip</label><input name="chip_id" value="{{ pet.chip_id or '' }}"></div>
        </div>

        <div class="row">
          <div><label>Vacunas</label><input name="vaccines" value="{{ pet.vaccines or '' }}"></div>
          <div><label>Castrado</label><input name="sterilized" value="{{ pet.sterilized or '' }}"></div>
        </div>

        <div class="row">
          <div><label>Alergias</label><input name="allergies" value="{{ pet.allergies or '' }}"></div>
          <div><label>Medicaci√≥n</label><input name="meds" value="{{ pet.meds or '' }}"></div>
        </div>

        <div class="row">
          <div><label>Temperamento</label><input name="temperament" value="{{ pet.temperament or '' }}"></div>
          <div><label>Se√±as particulares</label><input name="distinctive" value="{{ pet.distinctive or '' }}"></div>
        </div>

        <div class="row">
          <div><label>Recompensa</label><input name="reward" value="{{ pet.reward or '' }}"></div>
          <div><label>Notas</label><input name="notes" value="{{ pet.notes or '' }}"></div>
        </div>

        <div class="row">
          <div><label>Home lat</label><input name="home_lat" value="{{ pet.home_lat or '' }}"></div>
          <div><label>Home lon</label><input name="home_lon" value="{{ pet.home_lon or '' }}"></div>
        </div>

        <div style="height:10px"></div>
        <button class="btn btn-primary" type="submit" style="width:100%">Guardar cambios</button>
      </form>
    </div>

  </div>

<script>
  let points = JSON.parse('{{ points|tojson|escapejs }}');
  let pet = JSON.parse('{{ pet|tojson|escapejs }}');

  const map = L.map('map', { zoomControl: true });
  const startLat = (pet.last_lat ?? pet.home_lat ?? -32.889) || -32.889;
  const startLon = (pet.last_lon ?? pet.home_lon ?? -68.844) || -68.844;
  map.setView([startLat, startLon], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const markers = [];
  function addMarker(lat, lon, txt){
    const m = L.marker([lat, lon]).addTo(map).bindPopup(txt);
    markers.push(m);
  }

  // Puntos (m√°s reciente primero)
  if(points && points.length){
    points.forEach((p, idx) => {
      const label = idx === 0 ? "üìç √öltimo punto" : `Punto #${idx+1}`;
      const popup = `${label}<br>UTC: ${p.ts_utc}<br>Acc: ${p.accuracy ?? '‚Äî'} m<br>
        <a target="_blank" href="https://maps.google.com/?q=${p.lat},${p.lon}">Abrir en Maps</a>`;
      addMarker(p.lat, p.lon, popup);
    });
    const last = points[0];
    map.setView([last.lat, last.lon], 15);
  } else {
    addMarker(startLat, startLon, "Sin puntos GPS todav√≠a");
  }
</script>
</body>
</html>
